<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.board.mapper.BoardMapper">

    <!-- 게시글 등록 -->
    <insert id="insertBoard" parameterType="com.example.board.domain.BoardV0">
        INSERT INTO t_board (title, content, writer_id, regDate, delYn)
        VALUES (#{title}, #{content}, #{writerId}, NOW(), 'N')
    </insert>

    <!-- 게시글 목록 조회 (댓글 개수와 신규 여부 포함) -->
    <select id="selectBoardList" resultType="com.example.board.domain.BoardV0">
        SELECT 
            b.idx,
            b.title,
            b.content,
            u.username AS writerNm,
            b.writer_id,
            b.regDate,
            b.delYn,
            -- 댓글 개수 계산 (LEFT JOIN + COUNT)
            COALESCE(COUNT(c.idx), 0) AS commentCount,
            -- 신규 게시글 여부 (오늘 작성된 글이면 1, 아니면 0)
            CASE 
                WHEN DATE_FORMAT(b.regDate, '%Y-%m-%d') = DATE_FORMAT(NOW(), '%Y-%m-%d') 
                THEN 1 
                ELSE 0 
            END AS isNew
        FROM t_board b
        LEFT JOIN users u ON b.writer_id = u.user_id AND u.del_yn = 'N' AND u.active_yn = 'Y'
        LEFT JOIN t_comment c ON b.idx = c.boardIdx AND c.delYn = 'N'
        WHERE b.delYn = 'N'
        GROUP BY b.idx, b.title, b.content, u.username, b.writer_id, b.regDate, b.delYn
        ORDER BY b.regDate DESC
    </select>

    <!-- 게시글 삭제 (논리 삭제) -->
    <update id="deleteBoard" parameterType="Long">
        UPDATE t_board 
        SET delYn = 'Y' 
        WHERE idx = #{idx}
    </update>

    <!-- 게시글 수정 -->
    <update id="updateBoard" parameterType="com.example.board.domain.BoardV0">
        UPDATE t_board 
        SET title = #{title}, 
            content = #{content}
        WHERE idx = #{idx} 
          AND delYn = 'N'
    </update>

</mapper>
